
{% extends "base.html" %}
{% block content %}

<div class="info-box">
  <h4>üìä Welcome to the Survey Sample Size & MOE Planner!</h4>
  <p>This tool helps you plan survey sample sizes for various scenarios. Choose the planner that fits your needs below. Each section includes helpful explanations and examples to guide you through the process.</p>
</div>

<section class="grid">
  <!-- Single Group Planner -->
  <div class="card">
    <h3>üéØ Single Group Planner</h3>
    <p style="margin: 0 0 20px 0; opacity: 0.8;">Calculate the sample size needed for a single population group to achieve your target margin of error.</p>
    
    <div class="row">
      <div class="input-group">
        <label for="oneN">
          Population Size (N)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The total number of people in your target population. Leave empty for infinite population. This affects the finite population correction (FPC).</span>
          </span>
        </label>
        <input id="oneN" type="number" min="0" placeholder="e.g., 1200">
        <div class="example-text">Example: 1200 students in a university</div>
      </div>
      
      <div class="input-group">
        <label for="oneConf">
          Confidence Level
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The probability that your confidence interval contains the true population parameter. Higher confidence = wider intervals = larger sample needed.</span>
          </span>
        </label>
        <select id="oneConf">
          <option value="0.90">90%</option>
          <option value="0.95" selected>95%</option>
          <option value="0.99">99%</option>
        </select>
        <div class="example-text">95% is standard for most surveys</div>
      </div>
    </div>
    
    <div class="row">
      <div class="input-group">
        <label for="oneP">
          Expected Proportion (p)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Your best guess for the proportion of the population with the characteristic of interest. Use 0.5 when uncertain (most conservative).</span>
          </span>
        </label>
        <input id="oneP" type="number" min="0" max="1" step="0.01" value="0.5">
        <div class="example-text">0.5 = 50% (most conservative)</div>
      </div>
      
      <div class="input-group">
        <label for="oneDeff">
          Design Effect
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Accounts for clustering, stratification, or other complex sampling designs. 1.0 = simple random sampling, higher values = more complex designs.</span>
          </span>
        </label>
        <input id="oneDeff" type="number" min="1" step="0.01" value="1.0">
        <div class="example-text">1.0 = simple random sampling</div>
      </div>
      
      <div class="input-group">
        <label for="oneRR">
          Expected Response Rate
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The percentage of invited participants who complete your survey. Lower rates require more invitations to reach your target sample size.</span>
          </span>
        </label>
        <input id="oneRR" type="number" min="0.01" max="1" step="0.01" value="0.6">
        <div class="example-text">0.6 = 60% response rate</div>
      </div>
    </div>
    
    <div class="separator">OR</div>
    
    <div class="row">
      <div class="input-group">
        <label for="oneMOE">
          Target Margin of Error (¬±%)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The maximum acceptable difference between your sample estimate and the true population value. Smaller MOE = larger sample needed.</span>
          </span>
        </label>
        <input id="oneMOE" type="number" min="0.1" step="0.1" placeholder="e.g., 5.0">
        <div class="example-text">5.0 = ¬±5 percentage points</div>
      </div>
      
      <div class="input-group">
        <label for="oneNcomp">
          Given Sample Size
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">If you already have a sample size, enter it here to calculate the margin of error you'll achieve.</span>
          </span>
        </label>
        <input id="oneNcomp" type="number" min="1" step="1" placeholder="e.g., 385">
        <div class="example-text">Calculate MOE for existing n</div>
      </div>
      
      <div class="input-group">
        <label>&nbsp;</label>
        <button id="oneCalc">Calculate</button>
      </div>
    </div>
    
    <div id="oneOut">‚Äî</div>
  </div>

  <!-- Multi-Group Planner -->
  <div class="card">
    <h3>üë• Multi-Group Planner</h3>
    <p style="margin: 0 0 20px 0; opacity: 0.8;">Plan sample sizes across multiple population groups while maintaining overall precision or equal precision per group.</p>
    
    <div class="row">
      <div class="input-group">
        <label for="multiConf">
          Confidence Level
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Same as single group - the probability that your confidence intervals contain the true population parameters.</span>
          </span>
        </label>
        <select id="multiConf">
          <option value="0.90">90%</option>
          <option value="0.95" selected>95%</option>
          <option value="0.99">99%</option>
        </select>
      </div>
      
      <div class="input-group">
        <label for="multiMode">
          Planning Mode
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Overall MOE: Achieve target precision for the entire population. Per-group MOE: Achieve same precision for each group separately.</span>
          </span>
        </label>
        <select id="multiMode">
          <option value="overall" selected>Overall MOE target</option>
          <option value="per_group">Same MOE per group</option>
        </select>
      </div>
    </div>
    
    <div class="row">
      <div class="input-group">
        <label for="multiMOE">
          MOE Target (¬±%)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The target margin of error for your overall estimate (overall mode) or for each group separately (per-group mode).</span>
          </span>
        </label>
        <input id="multiMOE" type="number" min="0.5" step="0.1" value="5.0">
        <div class="example-text">5.0 = ¬±5 percentage points</div>
      </div>
      
      <div class="input-group">
        <label for="multiAlloc">
          Allocation Strategy
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Proportional: Sample size proportional to group size. Balanced: Equal sample sizes per group. Neyman: Optimal allocation based on group variances.</span>
          </span>
        </label>
        <select id="multiAlloc">
          <option value="proportional" selected>Proportional</option>
          <option value="balanced">Balanced</option>
          <option value="neyman">Neyman (optimal)</option>
        </select>
      </div>
    </div>

    <div class="info-box">
      <h4>üìã Group Configuration</h4>
      <p>Add your population groups below. Each group needs a name, population size (N), expected proportion (p), design effect, and response rate.</p>
    </div>

    <table id="groupTable">
      <thead>
        <tr>
          <th>Group Name</th>
          <th>Population (N)</th>
          <th>p estimate</th>
          <th>Design Effect</th>
          <th>Response Rate</th>
          <th>Min n</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <div class="row">
      <button id="addGroup" class="secondary">‚ûï Add Group</button>
      <button id="runMulti">üöÄ Plan Allocation</button>
    </div>
    
    <div id="multiOut">‚Äî</div>
  </div>

  <!-- A/B Testing Planner -->
  <div class="card">
    <h3>üî¨ A/B Difference in Proportions (Power)</h3>
    <p style="margin: 0 0 20px 0; opacity: 0.8;">Calculate sample sizes needed to detect differences between two groups with specified power and confidence.</p>
    
    <div class="row">
      <div class="input-group">
        <label for="abConf">
          Confidence Level
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The significance level (Œ±) for your hypothesis test. 95% confidence = 5% significance level.</span>
          </span>
        </label>
        <select id="abConf">
          <option value="0.90">90%</option>
          <option value="0.95" selected>95%</option>
          <option value="0.99">99%</option>
        </select>
      </div>
      
      <div class="input-group">
        <label for="abPower">
          Statistical Power
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The probability of detecting a true difference when it exists. Higher power = larger sample needed. 80% is standard.</span>
          </span>
        </label>
        <input id="abPower" type="number" min="0.5" max="0.99" step="0.01" value="0.8">
        <div class="example-text">0.8 = 80% power (standard)</div>
      </div>
      
      <div class="input-group">
        <label for="abDelta">
          Detectable Difference (Œî)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">The smallest difference between groups that you want to be able to detect. Smaller differences require larger samples.</span>
          </span>
        </label>
        <input id="abDelta" type="number" min="0.01" step="0.01" value="0.05">
        <div class="example-text">0.05 = 5 percentage points</div>
      </div>
    </div>
    
    <div class="row">
      <div class="input-group">
        <label for="abP1">
          Group A Proportion (p‚ÇÅ)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Expected proportion for the first group (control or baseline group).</span>
          </span>
        </label>
        <input id="abP1" type="number" min="0" max="1" step="0.01" value="0.5">
        <div class="example-text">Control group proportion</div>
      </div>
      
      <div class="input-group">
        <label for="abP2">
          Group B Proportion (p‚ÇÇ)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Expected proportion for the second group (treatment or comparison group).</span>
          </span>
        </label>
        <input id="abP2" type="number" min="0" max="1" step="0.01" value="0.5">
        <div class="example-text">Treatment group proportion</div>
      </div>
    </div>
    
    <div class="row">
      <div class="input-group">
        <label for="abDeff1">
          Design Effect A
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Design effect for group A. Accounts for clustering, stratification, or other complex sampling designs.</span>
          </span>
        </label>
        <input id="abDeff1" type="number" min="1" step="0.01" value="1.0">
        <div class="example-text">1.0 = simple random sampling</div>
      </div>
      
      <div class="input-group">
        <label for="abDeff2">
          Design Effect B
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Design effect for group B. Accounts for clustering, stratification, or other complex sampling designs.</span>
          </span>
        </label>
        <input id="abDeff2" type="number" min="1" step="0.01" value="1.0">
        <div class="example-text">1.0 = simple random sampling</div>
      </div>
    </div>
    
    <div class="row">
      <div class="input-group">
        <label for="abN1">
          Population N‚ÇÅ (optional)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Population size for group A. Leave empty for infinite population. Affects finite population correction.</span>
          </span>
        </label>
        <input id="abN1" type="number" min="0" placeholder="Leave empty for infinite">
        <div class="example-text">Optional: finite population correction</div>
      </div>
      
      <div class="input-group">
        <label for="abN2">
          Population N‚ÇÇ (optional)
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Population size for group B. Leave empty for infinite population. Affects finite population correction.</span>
          </span>
        </label>
        <input id="abN2" type="number" min="0" placeholder="Leave empty for infinite">
        <div class="example-text">Optional: finite population correction</div>
      </div>
      
      <div class="input-group">
        <label>&nbsp;</label>
        <button id="abCalc">Calculate</button>
      </div>
    </div>
    
    <div id="abOut">‚Äî</div>
  </div>
</section>

<script>
function addGroupRow(name="Campus A", N=800, p=0.5, deff=1.0, rr=0.6, min_n=0) {
  const tb = document.querySelector("#groupTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="g-name" value="${name}" placeholder="Group name"></td>
    <td><input class="g-N" type="number" value="${N}" min="0" placeholder="Population"></td>
    <td><input class="g-p" type="number" value="${p}" min="0" max="1" step="0.01" placeholder="0.5"></td>
    <td><input class="g-deff" type="number" value="${deff}" min="1" step="0.01" placeholder="1.0"></td>
    <td><input class="g-rr" type="number" value="${rr}" min="0.01" max="1" step="0.01" placeholder="0.6"></td>
    <td><input class="g-min" type="number" value="${min_n}" min="0" placeholder="Min n"></td>
    <td><button class="del danger" style="min-width: auto; padding: 8px 12px;">‚úï</button></td>
  `;
  tr.querySelector(".del").addEventListener("click", ()=> tr.remove());
  tb.appendChild(tr);
}

document.getElementById("addGroup").addEventListener("click", ()=> addGroupRow());
addGroupRow("Campus A", 800, 0.5, 1.0, 0.6, 0);
addGroupRow("Campus B", 1200, 0.5, 1.0, 0.5, 0);
addGroupRow("Campus C", 600, 0.5, 1.0, 0.55, 0);

document.getElementById("oneCalc").addEventListener("click", async () => {
  const N = parseInt(document.getElementById("oneN").value || "0", 10);
  const conf = parseFloat(document.getElementById("oneConf").value || "0.95");
  const p = parseFloat(document.getElementById("oneP").value || "0.5");
  const deff = parseFloat(document.getElementById("oneDeff").value || "1.0");
  const rr = parseFloat(document.getElementById("oneRR").value || "1.0");
  const moeField = document.getElementById("oneMOE");
  const nField = document.getElementById("oneNcomp");
  const payload = { N: N>0?N:null, conf, p_est:p, deff, response_rate: rr };
  
  if (moeField.value) payload.moe = parseFloat(moeField.value);
  else if (nField.value) payload.n = parseInt(nField.value, 10);
  else { alert("Enter either target MOE or given n."); return; }
  
  const res = await postJSON("/api/one", payload);
  if (!res.ok) { alert(res.error||"Error"); return; }
  
  document.getElementById("oneOut").innerHTML = `
    <div class="result-box">
      <h4>üìä Calculation Results</h4>
      <div class="result-item">
        <span class="result-label">Completes required:</span>
        <span class="result-value">${res.n_required}</span>
      </div>
      <div class="result-item">
        <span class="result-label">Invitations needed (@${(rr*100).toFixed(0)}% RR):</span>
        <span class="result-value">${res.invitations_needed}</span>
      </div>
      <div class="result-item">
        <span class="result-label">Achieved MOE:</span>
        <span class="result-value">${(res.moe_achieved*100).toFixed(2)}%</span>
      </div>
      ${res.fpc_applied ? '<div class="result-item"><span class="result-label">Finite Population Correction:</span><span class="result-value">Applied</span></div>' : ''}
    </div>
  `;
});

document.getElementById("runMulti").addEventListener("click", async () => {
  const rows = [...document.querySelectorAll("#groupTable tbody tr")];
  const groups = rows.map(tr => ({
    name: tr.querySelector(".g-name").value || "Group",
    N: parseInt(tr.querySelector(".g-N").value||"0",10),
    p_est: parseFloat(tr.querySelector(".g-p").value||"0.5"),
    deff: parseFloat(tr.querySelector(".g-deff").value||"1.0"),
    response_rate: parseFloat(tr.querySelector(".g-rr").value||"1.0"),
    min_n: parseInt(tr.querySelector(".g-min").value||"0",10)
  })).filter(g => g.N>0);
  
  if (!groups.length) { alert("Add at least one group with N>0"); return; }
  
  const conf = parseFloat(document.getElementById("multiConf").value||"0.95");
  const mode = document.getElementById("multiMode").value;
  const target_moe = parseFloat(document.getElementById("multiMOE").value||"5.0");
  const allocation = document.getElementById("multiAlloc").value;
  
  const res = await postJSON("/api/multi", { groups, conf, mode, target_moe, allocation });
  if (!res.ok) { alert(res.error||"Error"); return; }
  
  const d = res;
  let html = `
    <div class="result-box">
      <h4>üìä Multi-Group Allocation Results</h4>
      <div class="result-item">
        <span class="result-label">Total completes:</span>
        <span class="result-value">${d.total_n}</span>
      </div>
      <div class="result-item">
        <span class="result-label">Total invitations:</span>
        <span class="result-value">${d.total_invites}</span>
      </div>
      <div class="result-item">
        <span class="result-label">Overall MOE:</span>
        <span class="result-value">${(d.overall_moe*100).toFixed(2)}%</span>
      </div>
      <div class="result-item">
        <span class="result-label">Allocation strategy:</span>
        <span class="result-value">${d.allocation} (${d.mode})</span>
      </div>
    </div>
  `;
  
  html += `<div class="info-box"><h4>üìã Per-Group Details</h4><p>Sample sizes and invitations needed for each group:</p></div>`;
  html += "<table><thead><tr><th>Group</th><th>Population</th><th>p est</th><th>Deff</th><th>RR</th><th>n required</th><th>Invites</th></tr></thead><tbody>";
  d.per_group.forEach(g => {
    html += `<tr><td><strong>${g.name}</strong></td><td>${g.N}</td><td>${(g.p_est).toFixed(2)}</td><td>${g.deff.toFixed(2)}</td><td>${(g.response_rate*100).toFixed(0)}%</td><td><strong>${g.n_required}</strong></td><td>${g.invitations_needed}</td></tr>`;
  });
  html += "</tbody></table>";
  
  document.getElementById("multiOut").innerHTML = html;
});

document.getElementById("abCalc").addEventListener("click", async () => {
  const conf = parseFloat(document.getElementById("abConf").value||"0.95");
  const power = parseFloat(document.getElementById("abPower").value||"0.8");
  const delta = parseFloat(document.getElementById("abDelta").value||"0.05");
  const p1 = parseFloat(document.getElementById("abP1").value||"0.5");
  const p2 = parseFloat(document.getElementById("abP2").value||"0.5");
  const d1 = parseFloat(document.getElementById("abDeff1").value||"1.0");
  const d2 = parseFloat(document.getElementById("abDeff2").value||"1.0");
  const N1 = document.getElementById("abN1").value ? parseInt(document.getElementById("abN1").value,10) : null;
  const N2 = document.getElementById("abN2").value ? parseInt(document.getElementById("abN2").value,10) : null;
  
  const res = await postJSON("/api/ab", { conf, power, delta, p1_est:p1, p2_est:p2, deff1:d1, deff2:d2, N1, N2 });
  if (!res.ok) { alert(res.error||"Error"); return; }
  
  document.getElementById("abOut").innerHTML = `
    <div class="result-box">
      <h4>üî¨ A/B Test Sample Size Results</h4>
      <div class="result-item">
        <span class="result-label">Group A sample size:</span>
        <span class="result-value">${res.n_group1}</span>
      </div>
      <div class="result-item">
        <span class="result-label">Group B sample size:</span>
        <span class="result-value">${res.n_group2}</span>
      </div>
      <div class="result-item">
        <span class="result-label">Total sample size:</span>
        <span class="result-value">${res.n_group1 + res.n_group2}</span>
      </div>
    </div>
    <div class="info-box">
      <h4>üìù Notes</h4>
      <p>This calculation provides power-based sizing for detecting differences in proportions between two groups. The sample sizes account for your specified confidence level (${(conf*100).toFixed(0)}%), power (${(power*100).toFixed(0)}%), and detectable difference (${(delta*100).toFixed(1)} percentage points).</p>
    </div>
  `;
});
</script>

{% endblock %}
