
{% extends "base.html" %}
{% block content %}
<section class="controls">
  <div class="card">
    <h3>Scenario Controls</h3>
    
    <div class="row">
      <div class="control-group">
        <label class="tooltip" data-tooltip="Enable legacy admissions for private colleges">
          <input type="checkbox" id="legacy_on_private" checked> 
          <span>Legacy enabled at privates</span>
        </label>
      </div>
      
      <div class="control-group">
        <label class="tooltip" data-tooltip="Require test scores at elite private colleges">
          <input type="checkbox" id="test_required_private_elite"> 
          <span>Test-required at top private colleges</span>
        </label>
        <label class="tooltip" data-tooltip="Number of elite private colleges to make test-required">
          Count: <input type="number" id="num_private_elites_test_required" value="4" min="1" max="12">
        </label>
      </div>
    </div>
    
    <div class="row">
      <div class="control-group">
        <label class="tooltip" data-tooltip="Percentage of seats reserved for first-generation students">
          First-gen reserve (%): <input type="number" id="reserve_first_gen" value="0" min="0" max="30" step="1">
        </label>
      </div>
      
      <div class="control-group">
        <label class="tooltip" data-tooltip="Percentage of seats reserved for rural students">
          Rural reserve (%): <input type="number" id="reserve_rural" value="0" min="0" max="20" step="1">
        </label>
      </div>
      
      <div class="control-group">
        <label class="tooltip" data-tooltip="Percentage of seats reserved for Pell Grant recipients">
          Pell reserve (%): <input type="number" id="reserve_pell" value="0" min="0" max="30" step="1">
        </label>
      </div>
    </div>
    
    <div class="row">
      <div class="control-group">
        <label class="tooltip" data-tooltip="Percentage of public college seats allocated to in-state students">
          Public in-state share (%): <input type="number" id="public_in_state_share" value="70" min="0" max="95" step="5">
        </label>
      </div>
    </div>
    
    <div class="row">
      <button id="runBtn" class="primary-btn">
        <span class="btn-text">Run Scenario</span>
        <span class="btn-loading" style="display: none;">
          <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416">
              <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
              <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
            </circle>
          </svg>
          Running...
        </span>
      </button>
    </div>
  </div>
</section>

<section id="results" class="results" style="display: none;">
  <div class="card fade-in">
    <h3>Topline Results</h3>
    <div id="topline"></div>
  </div>

  <div class="grid">
    <div class="card slide-up" style="animation-delay: 0.1s;">
      <h3>Group Admit Rates</h3>
      <div class="table-container">
        <table id="groupTable">
          <thead>
            <tr>
              <th>Group</th>
              <th>Baseline</th>
              <th>Scenario</th>
              <th>Î” (pp)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div class="card slide-up" style="animation-delay: 0.2s;">
      <h3>College Fill (Sample)</h3>
      <div class="table-container">
        <table id="collegeTable">
          <thead>
            <tr>
              <th>College</th>
              <th>Cap</th>
              <th>Fill%</th>
              <th>In-State%</th>
              <th>First-Gen%</th>
              <th>Pell%</th>
              <th>Rural%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="card slide-up" style="animation-delay: 0.3s;">
    <h3>Scenario Summary</h3>
    <div id="scenarioSummary" class="scenario-summary"></div>
  </div>
</section>

<script>
let isRunning = false;

async function runScenario() {
  if (isRunning) return;
  
  isRunning = true;
  const btn = document.getElementById("runBtn");
  const btnText = btn.querySelector(".btn-text");
  const btnLoading = btn.querySelector(".btn-loading");
  
  btn.disabled = true;
  btnText.style.display = "none";
  btnLoading.style.display = "inline-flex";
  
  try {
    const payload = {
      legacy_on_private: document.getElementById("legacy_on_private").checked,
      test_required_private_elite: document.getElementById("test_required_private_elite").checked,
      num_private_elites_test_required: parseInt(document.getElementById("num_private_elites_test_required").value || "4", 10),
      reserve_first_gen: parseFloat(document.getElementById("reserve_first_gen").value || "0")/100.0,
      reserve_rural: parseFloat(document.getElementById("reserve_rural").value || "0")/100.0,
      reserve_pell: parseFloat(document.getElementById("reserve_pell").value || "0")/100.0,
      public_in_state_share: parseFloat(document.getElementById("public_in_state_share").value || "70")/100.0
    };
    
    console.log('Sending payload:', payload);
    const res = await postJSON("/api/run", payload);
    console.log('API response:', res);
    
    if (!res.ok) { 
      showError("Run failed"); 
      return; 
    }
    
    Toast.success("Scenario completed successfully!");
    
    render(res);
    const resultsSection = document.getElementById("results");
    resultsSection.style.display = "block";
    // Trigger reflow and then fade in
    resultsSection.offsetHeight;
    resultsSection.style.opacity = "1";
    
  } catch (error) {
    console.error('Error running scenario:', error);
    showError("An error occurred while running the scenario");
  } finally {
    isRunning = false;
    btn.disabled = false;
    btnText.style.display = "inline";
    btnLoading.style.display = "none";
  }
}

function showError(message) {
  Toast.error(message);
}

function render(res) {
  console.log('Rendering with data:', res);
  const base = res.baseline, alt = res.alternative, delta = res.delta;
  
  renderTopline(base, alt, delta);
  renderGroupTable(base, alt);
  renderCollegeTable(alt);
  renderScenarioSummary(res);
}

function renderTopline(base, alt, delta) {
  const tl = document.getElementById("topline");
  const dr = (k) => (pct(alt.overall[k]) + " (" + sign(delta.overall[k]) + (delta.overall[k]*100).toFixed(1) + "pp vs base)");
  
  tl.innerHTML = `
    <div>
      <strong>Overall admit rate:</strong> 
      <span class="metric-value">${dr("admit_rate")}</span>
    </div>
    <div>
      <strong>In-state share (admits):</strong> 
      <span class="metric-value">${dr("in_state_share_among_admits")}</span>
    </div>
  `;
}

function renderGroupTable(base, alt) {
  const groups = Object.keys(alt.by_group);
  const tbody = document.querySelector("#groupTable tbody");
  tbody.innerHTML = "";
  
  groups.forEach(g => {
    const b = base.by_group[g], a = alt.by_group[g];
    const d = (a.admit_rate - b.admit_rate)*100;
    const tr = document.createElement("tr");
    
    tr.innerHTML = `
      <td><strong>${formatGroupName(g)}</strong></td>
      <td>${pct(b.admit_rate)}</td>
      <td>${pct(a.admit_rate)}</td>
      <td class="${d>=0?'pos':'neg'}">${d.toFixed(1)}pp</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderCollegeTable(alt) {
  const ct = document.querySelector("#collegeTable tbody");
  ct.innerHTML = "";
  
  const entries = Object.entries(alt.by_college).slice(0,12);
  entries.forEach(([cid, row]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${row.name}</strong></td>
      <td>${row.capacity}</td>
      <td class="${getFillRateClass(row.fill_rate)}">${pct(row.fill_rate)}</td>
      <td>${pct(row.in_state_share)}</td>
      <td>${pct(row.first_gen_share)}</td>
      <td>${pct(row.pell_share)}</td>
      <td>${pct(row.rural_share)}</td>
    `;
    ct.appendChild(tr);
  });
}

function renderScenarioSummary(res) {
  const summary = document.getElementById("scenarioSummary");
  const alt = res.alternative;
  const base = res.baseline;
  
  // Calculate totals from available data
  const totalStudents = Object.values(alt.by_group).reduce((sum, group) => sum + group.count, 0);
  const totalColleges = Object.keys(alt.by_college).length;
  
  // Calculate admitted students
  const admittedStudents = Math.round(totalStudents * alt.overall.admit_rate);
  
  // Find significant changes
  const changes = [];
  
  // Overall changes
  if (Math.abs(res.delta.overall.admit_rate) > 0.001) {
    const change = (res.delta.overall.admit_rate * 100).toFixed(1);
    const direction = res.delta.overall.admit_rate > 0 ? 'increased' : 'decreased';
    changes.push(`Overall admit rate ${direction} by ${Math.abs(change)}pp`);
  }
  
  if (Math.abs(res.delta.overall.in_state_share_among_admits) > 0.001) {
    const change = (res.delta.overall.in_state_share_among_admits * 100).toFixed(1);
    const direction = res.delta.overall.in_state_share_among_admits > 0 ? 'increased' : 'decreased';
    changes.push(`In-state share ${direction} by ${Math.abs(change)}pp`);
  }
  
  // Group changes (only show significant ones)
  const significantGroupChanges = Object.entries(res.delta.by_group)
    .filter(([_, data]) => Math.abs(data.admit_rate) > 0.005) // Only show changes > 0.5pp
    .sort((a, b) => Math.abs(b[1].admit_rate) - Math.abs(a[1].admit_rate)) // Sort by magnitude
    .slice(0, 3); // Show top 3 changes
  
  if (significantGroupChanges.length > 0) {
    const groupChangeText = significantGroupChanges
      .map(([group, data]) => {
        const change = (data.admit_rate * 100).toFixed(1);
        const direction = data.admit_rate > 0 ? '+' : '';
        return `${formatGroupName(group)}: ${direction}${change}pp`;
      })
      .join(', ');
    changes.push(`Top group changes: ${groupChangeText}`);
  }
  
  // College fill rate changes
  const collegeChanges = [];
  Object.entries(alt.by_college).forEach(([cid, altCollege]) => {
    const baseCollege = base.by_college[cid];
    if (baseCollege && Math.abs(altCollege.fill_rate - baseCollege.fill_rate) > 0.05) {
      const change = ((altCollege.fill_rate - baseCollege.fill_rate) * 100).toFixed(1);
      const direction = altCollege.fill_rate > baseCollege.fill_rate ? '+' : '';
      collegeChanges.push(`${altCollege.name}: ${direction}${change}pp`);
    }
  });
  
  if (collegeChanges.length > 0) {
    changes.push(`Notable college changes: ${collegeChanges.slice(0, 3).join(', ')}`);
  }
  
  // Policy summary
  const policySummary = [];
  if (res.delta.overall.admit_rate !== 0 || res.delta.overall.in_state_share_among_admits !== 0) {
    policySummary.push('Policy changes affected overall outcomes');
  } else if (significantGroupChanges.length > 0) {
    policySummary.push('Policy changes affected specific student groups');
  } else if (collegeChanges.length > 0) {
    policySummary.push('Policy changes affected college fill rates');
  } else {
    policySummary.push('No significant policy impact detected');
  }
  
  // Add more context when no changes
  if (changes.length === 0) {
    changes.push('Current parameters match baseline scenario');
    changes.push('Try adjusting reserve percentages or test requirements');
  }
  
  summary.innerHTML = `
    <div class="summary-stats">
      <div class="stat-item">
        <span class="stat-label">Total Students:</span>
        <span class="stat-value">${totalStudents.toLocaleString()}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Admitted Students:</span>
        <span class="stat-value">${admittedStudents.toLocaleString()} (${(alt.overall.admit_rate * 100).toFixed(1)}%)</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Total Colleges:</span>
        <span class="stat-value">${totalColleges}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Policy Impact:</span>
        <span class="stat-value">${policySummary[0]}</span>
      </div>
      <div class="stat-item full-width">
        <span class="stat-label">Key Changes:</span>
        <span class="stat-value">${changes.length > 0 ? changes.join('; ') : 'No significant changes detected'}</span>
      </div>
    </div>
  `;
}

function formatGroupName(group) {
  const names = {
    'first_gen': 'First-Generation',
    'non_first_gen': 'Non-First-Generation',
    'income_q1': 'Income Q1 (Lowest)',
    'income_q2': 'Income Q2',
    'income_q3': 'Income Q3',
    'income_q4': 'Income Q4',
    'income_q5': 'Income Q5 (Highest)',
    'pell': 'Pell Grant Recipients',
    'rural': 'Rural Students'
  };
  return names[group] || group;
}

function getFillRateClass(fillRate) {
  if (fillRate >= 0.9) return 'pos';
  if (fillRate >= 0.7) return 'warning';
  return 'neg';
}

// Event listeners
document.getElementById("runBtn").addEventListener("click", runScenario);

// Add some interactivity to form controls
document.getElementById("test_required_private_elite").addEventListener("change", function() {
  const countInput = document.getElementById("num_private_elites_test_required");
  countInput.disabled = !this.checked;
  if (!this.checked) {
    countInput.value = "4";
  }
});

// Add input validation and real-time feedback
document.querySelectorAll('input[type="number"]').forEach(input => {
  input.addEventListener('input', function() {
    const value = parseFloat(this.value);
    const min = parseFloat(this.min);
    const max = parseFloat(this.max);
    
    if (value < min || value > max) {
      this.classList.add('invalid');
    } else {
      this.classList.remove('invalid');
    }
  });
});

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + Enter to run scenario
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    if (!isRunning) {
      runScenario();
    }
  }
  
  // Escape to reset form
  if (e.key === 'Escape') {
    e.preventDefault();
    resetForm();
  }
});

// Form reset functionality
function resetForm() {
  document.getElementById("legacy_on_private").checked = true;
  document.getElementById("test_required_private_elite").checked = false;
  document.getElementById("num_private_elites_test_required").value = "4";
  document.getElementById("reserve_first_gen").value = "0";
  document.getElementById("reserve_rural").value = "0";
  document.getElementById("reserve_pell").value = "0";
  document.getElementById("public_in_state_share").value = "70";
  
  // Update disabled state
  document.getElementById("num_private_elites_test_required").disabled = true;
  
  Toast.info("Form reset to default values");
}

// Add reset button
const resetBtn = document.createElement('button');
resetBtn.textContent = 'Reset Form';
resetBtn.className = 'secondary-btn';
resetBtn.addEventListener('click', resetForm);

// Insert reset button after run button
document.getElementById("runBtn").parentNode.appendChild(resetBtn);

// Initialize form state
document.addEventListener("DOMContentLoaded", function() {
  const testRequired = document.getElementById("test_required_private_elite");
  const countInput = document.getElementById("num_private_elites_test_required");
  countInput.disabled = !testRequired.checked;
  
  // Add loading state to results section
  const resultsSection = document.getElementById("results");
  resultsSection.style.opacity = "0";
  resultsSection.style.transition = "opacity 0.3s ease";
});
</script>

<style>
.control-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.primary-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
}

.btn-loading {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.metric-value {
  color: var(--accent);
  font-weight: 500;
}

.table-container {
  overflow-x: auto;
  border-radius: 8px;
  border: 1px solid var(--line);
}

.scenario-summary {
  margin-top: 16px;
}

.summary-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.stat-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.stat-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--muted);
  font-weight: 600;
}

.stat-value {
  font-size: 18px;
  font-weight: 600;
  color: #f8fafc;
}

.warning {
  color: var(--warning);
  font-weight: 600;
}
</style>
{% endblock %}
